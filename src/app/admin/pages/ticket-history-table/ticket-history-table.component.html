<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-primary">Historial de Cambios de Tickets</h1>
    <p class="text-gray-600">Auditoría completa de todas las modificaciones realizadas en el sistema</p>
  </div>

  <!-- Filtros -->
  <div class="bg-base-200 rounded-lg p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Número de Ticket -->
      <div>
        <label class="label">
          <span class="label-text">Número de Ticket</span>
        </label>
        <input type="text" class="input input-bordered w-full" placeholder="INC-000001"
          [(ngModel)]="searchCriteria.ticketNumber" (input)="onSearchChange()">
      </div>

      <!-- Usuario -->
      <div>
        <label class="label">
          <span class="label-text">Usuario</span>
        </label>
        <input type="text" class="input input-bordered w-full" placeholder="Nombre del usuario"
          [(ngModel)]="searchCriteria.updatedBy" (input)="onSearchChange()">
      </div>

      <!-- Fecha Inicio -->
      <div>
        <label class="label">
          <span class="label-text">Fecha Desde</span>
        </label>
        <input type="date" class="input input-bordered w-full" [(ngModel)]="searchCriteria.startDate"
          (change)="onSearchChange()">
      </div>

      <!-- Fecha Fin -->
      <div>
        <label class="label">
          <span class="label-text">Fecha Hasta</span>
        </label>
        <input type="date" class="input input-bordered w-full" [(ngModel)]="searchCriteria.endDate"
          (change)="onSearchChange()">
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="flex justify-end gap-2 mt-4">
      <button class="btn btn-ghost" (click)="clearFilters()">
        Limpiar Filtros
      </button>
      <button class="btn btn-primary" (click)="loadHistory()">
        Buscar
      </button>
    </div>
  </div>

  <!-- Loading -->
  @if (isLoading()) {
  <div class="flex justify-center py-8">
    <span class="loading loading-spinner loading-lg"></span>
  </div>
  }

  <!-- Error -->
  @if (error()) {
  <div class="alert alert-error mb-4">
    <span>{{ error() }}</span>
  </div>
  }

  <!-- Tabla -->
  @if (!isLoading() && history().length > 0) {
  <div class="bg-base-100 rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr class="bg-base-300">
            <th class="text-left">Ticket</th>
            <th class="text-left">Usuario</th>
            <th class="text-left">Campo Modificado</th>
            <th class="text-left">Valor Anterior</th>
            <th class="text-left">Valor Nuevo</th>
            <th class="text-left">Fecha/Hora</th>
            <th class="text-left">Ver todo</th>
          </tr>
        </thead>
        <tbody>
          @for (record of history(); track record.id) {
          <tr class="hover:bg-base-200">
            <td class="font-mono font-bold text-primary">
              {{ getTicketNumber(record) }}
            </td>
            <td>
              <div class="flex items-center gap-2">
                <!-- <div class="avatar placeholder">
                          <div class="bg-neutral text-neutral-content rounded-full w-8">
                            <span class="text-xs">
                              {{ getInitials(record.updatedBy.fullName || 'Usuario') }}
                            </span>
                          </div>
                        </div> -->
                <div>
                  <div class="font-medium">{{ record.updatedBy.fullName || 'N/A' }}</div>
                  <div class="text-xs text-gray-500">{{ record.updatedBy.email || '' }}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge badge-outline">
                {{ getFieldLabel(getFirstChangedField(record.changedFields)) }}
              </span>
            </td>
            <td class="max-w-xs">
              <div class="text-xs line-through text-error bg-error/10 p-1 rounded">
                {{ getDisplayValue(record.oldValues, record.changedFields, 'old') }}
              </div>
            </td>
            <td class="max-w-xs">
              <div class="text-xs font-semibold text-success bg-success/10 p-1 rounded">
                {{ getDisplayValue(record.newValues, record.changedFields, 'new') }}
              </div>
            </td>
            <td>
              <div class="text-xs font-medium">
                {{ formatVenezuelaDate(record.createdAt) }}
              </div>
              <div class="text-xs text-gray-500">
                {{ formatVenezuelaTime(record.createdAt) }}
              </div>
            </td>
            <td class="text-center">
              <div class="tooltip tooltip-left" data-tip="Ver historial completo de cambios del ticket">
                <button class="btn btn-circle btn-sm" [routerLink]="['/admin/tickets', record.ticketId, 'history']">
                  <img class="" src="assets/icons/history.svg" alt="" width=100%>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginación -->
  @if (totalPages() > 1) {
  <div class="join flex justify-center mt-6">
    <button class="join-item btn" [class.btn-disabled]="currentPage() === 1" (click)="changePage(currentPage() - 1)">
      «
    </button>

    @for (page of getPaginationRange(); track page) {
    @if (page === '...') {
    <button class="join-item btn btn-disabled">...</button>
    } @else {
    <button class="join-item btn" [class.btn-primary]="currentPage() === page" (click)="changePage(page)">
      {{ page }}
    </button>
    }
    }

    <button class="join-item btn" [class.btn-disabled]="currentPage() === totalPages()"
      (click)="changePage(currentPage() + 1)">
      »
    </button>
  </div>
  }

  <!-- Contador de resultados -->
  <div class="text-center mt-4 text-sm text-gray-600">
    Mostrando {{ history().length }} de {{ totalCount() }} registros
  </div>
  }

  <!-- Sin resultados -->
  @if (!isLoading() && history().length === 0) {
  <div class="text-center py-8">
    <div class="text-gray-400 mb-4">
      <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
        </path>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-600">No se encontraron registros.</h3>
    <p class="text-yellow-400">Es posible que el ticket que buscas no tiene cambios aún.</p>
    <p class="text-gray-500">Intenta ajustar los filtros de búsqueda.</p>
  </div>
  }
</div>

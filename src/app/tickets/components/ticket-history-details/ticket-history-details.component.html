<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold text-primary">Historial Completo de Cambios</h1>
        <p class="text-gray-600">Ticket: {{ ticketNumber() }}</p>
      </div>
      @if (ticketId()) {
      <button class="btn btn-neutral" [routerLink]="['/admin/tickets/history']">
        ← Volver
      </button>
      }
    </div>
  </div>

  <!-- Información del Ticket -->
  @if (ticket()) {
  <div class="bg-base-200 rounded-lg p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
      <div>
        <span class="font-semibold">Número:</span> {{ ticket()?.nro_ticket }}
      </div>
      <div>
        <span class="font-semibold">Grupo:</span> {{ ticket()?.group }}
      </div>
      <div>
        <span class="font-semibold">Estatus:</span> {{ ticket()?.status }}
      </div>
      <div>
        <span class="font-semibold">Severidad:</span> {{ ticket()?.severity }}
      </div>
      <div>
        <span class="font-semibold">Plataforma:</span> {{ ticket()?.platform }}
      </div>
      <div>
        <span class="font-semibold">Origen:</span> {{ ticket()?.origin }}
      </div>
    </div>
  </div>
  }

  <!-- Loading del ticket ID -->
  @if (!ticketId()) {
  <div class="flex justify-center py-8">
    <span class="loading loading-spinner loading-lg"></span>
    <span class="ml-2">Cargando información del ticket...</span>
  </div>
  }

  <!-- Loading del historial -->
  @if (ticketId() && isLoading()) {
  <div class="flex justify-center py-8">
    <span class="loading loading-spinner loading-lg"></span>
    <span class="ml-2">Cargando historial de cambios...</span>
  </div>
  }

  <!-- Error -->
  @if (error()) {
  <div class="alert alert-error mb-4">
    <span>{{ error() }}</span>
  </div>
  }

  <!-- Historial de Cambios -->
  @if (ticketId() && !isLoading() && history().length > 0) {
  <div class="space-y-6">
    @for (record of history(); track record.id; let i = $index) {
    <div class="bg-base-100 rounded-lg shadow-md p-6 border-l-4 border-primary">
      <!-- Header del registro -->
      <div class="flex justify-between items-start mb-4 pb-4 border-b">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <span class="badge badge-info badge-lg">{{ record.action }}</span>
            <span class="text-sm font-medium text-gray-700">
              {{ formatVenezuelaDateTime(record.createdAt) }}
            </span>
          </div>
          <div class="flex items-center gap-2">
            <div class="avatar placeholder">
              <div class="bg-primary text-primary-content rounded-full w-8">
                <span class="text-xs font-bold ml-1.5">
                  {{ getInitials(record.updatedBy.fullName || 'Usuario') }}
                </span>
              </div>
            </div>
            <div>
              <div class="font-semibold">{{ record.updatedBy.fullName || 'N/A' }}</div>
              <div class="text-xs text-gray-500">{{ record.updatedBy.email || '' }}</div>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm font-semibold text-primary">Modificación #{{ history().length - i }}</div>
          <div class="text-xs text-gray-500">{{ getChangedFields(record.changedFields).length }} campos cambiados</div>
        </div>
      </div>

      <!-- Campos modificados -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        @for (change of getDetailedChanges(record); track change.field) {
        <div class="bg-base-200 rounded-lg p-3">
          <h4 class="font-semibold text-primary mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-primary rounded-full"></span>
            {{ change.label }}
          </h4>
          <div class="space-y-2">
            <div class="line-through text-error bg-error/20 p-2 rounded text-sm border border-error/30">
              <span class="font-medium text-error">Anterior:</span>
              <span class="ml-1">{{ change.oldValue }}</span>
            </div>
            <div class="text-success font-semibold bg-success/20 p-2 rounded text-sm border border-success/30">
              <span class="font-medium text-success">Nuevo:</span>
              <span class="ml-1">{{ change.newValue }}</span>
            </div>
          </div>
        </div>
        }
      </div>

      <!-- Resumen de campos modificados -->
      @if (getChangedFields(record.changedFields).length > 0) {
      <div class="mt-4 p-3 bg-info/10 rounded border border-info/20">
        <span class="text-sm font-medium text-info">Resumen: </span>
        <div class="flex flex-wrap gap-1 mt-1">
          @for (field of getChangedFields(record.changedFields); track field) {
          <span class="badge badge-info badge-outline badge-sm">
            {{ getFieldLabel(field) }}
          </span>
          }
        </div>
      </div>
      }
    </div>
    }
  </div>
  }

  <!-- Sin resultados -->
  @if (ticketId() && !isLoading() && history().length === 0) {
  <div class="text-center py-12">
    <div class="text-gray-400 mb-4">
      <svg class="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
    </div>
    <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay historial de cambios</h3>
    <p class="text-gray-500 mb-4">Este ticket no ha sido modificado aún</p>
    @if (ticketId()) {
    <button class="btn btn-primary" [routerLink]="['/admin/tickets/by', ticketId()]">
      Ir al Ticket
    </button>
    }
  </div>
  }
</div>

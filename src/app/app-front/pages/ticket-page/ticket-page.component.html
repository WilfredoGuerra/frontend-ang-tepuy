@if (ticketResource.error()) {
<section class="flex flex-col items-center justify-center mt-10">
  <h1>No se encontr√≥ el ticket</h1>
  <a (click)="goBack()" class="link-primary cursor-pointer">
    <img class="mt-1" src="assets/icons/{{ 'material-symbols--chat-error-rounded' }}.svg" alt="" width=100%>
    Regresar
  </a>
</section>
}

@if (ticketResource.isLoading()) {
<div class="flex justify-center items-center h-screen">
  <span class="loading loading-ring loading-xl"></span>
</div>
}

@if (ticketResource.hasValue()) {
<div class="tabs tabs-lift mb-4">
  <input type="radio" name="my_tabs_3" class="tab text-green-500 font-bold" aria-label="Inicio" checked="checked" />
  <div class="tab-content bg-base-100 border-base-300 p-6">
    <div class="bg-base-300 min-h-screen p-4 md:p-6">
      <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="grid grid-cols-1 lg:grid-cols-1 gap-3 mb-2">
          <div class="bg-base-100 rounded-xl shadow-sm p-6 card-hover">
            <header class="mb-2">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <div class="flex justify-between items-center gap-2">
                  <h1 class="text-xl font-bold text-primary">Nro. de Ticket:</h1>
                  <p class="text-xl uppercase text-secondary">{{ ticketResource.value().nro_ticket }}</p>
                </div>
                <div class="flex space-x-2">
                  <span class="uppercase font-bold">
                    @if ( ticketResource.value().statusId === 1 ) {
                    <span class="badge bg-warning/20 text-warning badge-md p-4">{{ ticketResource.value().status
                      }}</span>
                    }
                    @else if (ticketResource.value().statusId === 2) {
                    <span class="badge bg-error/20 text-error badge-md p-4">{{ ticketResource.value().status }}</span>
                    }
                    @else {
                    <span class="badge bg-success/20 text-success badge-md p-4">{{ ticketResource.value().status
                      }}</span>
                    }
                  </span>
                </div>
                <div>
                  <h3 class="text-md font-semibold">
                    <p class="text-primary">Generado por:</p>
                    {{ ticketResource.value().user?.fullName }} {{ ticketResource.value().user?.surnames || '' }}
                  </h3>
                </div>
              </div>
            </header>

            <p class="text-secondary font-semibold">Definici√≥n del problema:</p>
            <span class="uppercase">{{ ticketResource.value().definition_problem }}</span>

            <!-- Section network element/fiber length -->
            <!-- <div class="network-section">
              <div class="text-primary font-mono uppercase ticket-content">
                @if (ticketResource.value().network_elements?.length) {
                <div class="field">
                  <span class="field-name">Modelo:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.model }}</span>
                  <span class="comma-separator">,</span>
                </div>

                <div class="field">
                  <span class="field-name">Proveedor:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.provider?.provider_name
                    }}</span>
                  <span class="comma-separator">,</span>
                </div>

                <div class="field">
                  <span class="field-name">Descripci√≥n:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.description }}</span>
                  <span class="comma-separator">,</span>
                </div>

                <div class="field">
                  <span class="field-name">Acr√≥nimo:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.acronym }}</span>
                  <span class="comma-separator">,</span>
                </div>

                @if (ticketResource.value().network_elements?.[0]?.management_ip) {
                <div class="field">
                  <span class="field-name">IpG:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.management_ip }}</span>
                  <span class="comma-separator">,</span>
                </div>
                }

                @if (ticketResource.value().network_elements?.[0]?.service_ip) {
                <div class="field">
                  <span class="field-name">IpS:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.service_ip }}</span>
                  <span class="comma-separator">,</span>
                </div>
                }

                @if (ticketResource.value().network_elements?.[0]?.adsl_ip) {
                <div class="field">
                  <span class="field-name">IpAdsl:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.adsl_ip }}</span>
                  <span class="comma-separator">,</span>
                </div>
                }

                <div class="field">
                  <span class="field-name">Central:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.central?.central_name
                    }}</span>
                  <span class="comma-separator">,</span>
                </div>

                <div class="field">
                  <span class="field-name">Estado:</span>
                  <span class="field-value">{{ ticketResource.value().network_elements?.[0]?.central?.state?.state
                    }}</span>
                  <span class="comma-separator">.</span>
                </div>
                } @else if (ticketResource.value().fiberLengthId && ticketResource.value().fiber_length) {
                <div class="flex mt-2">
                  <div class="flex flex-row ">
                    <p>Tramo de fibra √≥ptica:</p>
                    <div>
                      {{ ticketResource.value().fiber_length?.section_name }},
                    </div>
                  </div>
                  <span class="font-mono uppercase">
                    <p>Del estado: {{ ticketResource.value().fiber_length?.stateA?.state }}</p>
                  </span>
                </div>
                }
              </div>
            </div> -->
            <!-- End section network element/fiber length -->

            <div class="divider my-1"></div>

            <div class="flex flex-row justify-between">
              <div>
                <p class="text-secondary font-semibold">Hora creaci√≥n del ticket</p>
                <!-- <p class="">{{ ticketResource.value().createdDate | date : "d/MM/yyyy, hh:mm a" }}</p> -->
                <p class="">{{ formatVenezuelaTime(ticketResource.value().createdDate, 'dd/MM/yyyy, h:mm a') }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Hora de Inicio Falla</p>
                <p class="">{{ ticketResource.value().date_hif | date : "d/MM/yyyy, hh:mm a" }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Hora Diagn√≥stico COR</p>
                <p class="">{{ ticketResource.value().date_hdc | date : "d/MM/yyyy, hh:mm a" }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Hora Contacto T√©cnico</p>
                <p class="">{{ ticketResource.value().date_hct | date : "d/MM/yyyy, hh:mm a" }}</p>
              </div>
            </div>

            <div class="divider my-1"></div>

            <div class="flex flex-row justify-between">
              <div>
                <p class="text-secondary font-semibold">Grupo</p>
                <p class="first-letter:capitalize">{{ ticketResource.value().group }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Plataforma</p>
                <p class="first-letter:capitalize">{{ ticketResource.value().platform }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Severidad</p>
                <p class="first-letter:capitalize">{{ ticketResource.value().severity }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Estatus</p>
                <p class="first-letter:capitalize">
                  <span class="uppercase">
                    @if ( ticketResource.value().statusId === 1 ) {
                    <span class="badge bg-warning/20 text-warning badge-md pb-1">{{ ticketResource.value().status
                      }}</span>
                    }
                    @else if (ticketResource.value().statusId === 2) {
                    <span class="badge bg-red-600 badge-sm font-bold">{{ ticketResource.value().status }}</span>
                    }
                    @else {
                    <span class="badge bg-green-700 badge-sm font-bold">{{ ticketResource.value().status }}</span>
                    }
                  </span>
                </p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Origen</p>
                <p class="first-letter:capitalize">{{ ticketResource.value().origin }}</p>
              </div>
            </div>

            <div class="divider my-1"></div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-secondary font-semibold">Falla Reportada:</p>
                <p class="first-letter:capitalize">{{ ticketResource.value().failure }}</p>
              </div>
              <div>
                <p class="text-secondary font-semibold">Impacto</p>
                <p class="">{{ ticketResource.value().impact }}.</p>
              </div>
            </div>

          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-2">
          <div class="bg-base-100 rounded-xl shadow-sm p-6 card-hover">
            <p class="text-secondary font-semibold">Evidencias del problema</p>
            <p class="">{{ ticketResource.value().evidences_problem }}</p>
          </div>

          <div class="bg-base-100 rounded-xl shadow-sm p-6 card-hover">
            <p class="text-secondary font-semibold">Hip√≥tesis</p>
            <p class="">{{ ticketResource.value().hypothesis }}</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-1 gap-3">
          <div class="space-y-6">
            <div class="bg-base-100 rounded-xl shadow-sm p-6 card-hover">
              @if (ticketResource.value().personalRegionId) {
              <div>
                <p class="text-secondary font-semibold">Personal de √°rea resolutoria</p>
                <div class="space-y-4 mb-3">
                  <div class="flex gap-2">
                    <p class="capitalize">
                      {{ ticketResource.value().personal_region?.names }}, {{
                      ticketResource.value().personal_region?.surnames }}
                    </p>
                    <p class="first-letter:capitalize">
                      @for( position of ticketResource.value().personal_region?.position; track $index) {
                    <p>({{ position.position }}) /</p>
                    }
                    </p>
                    <p class="italic">
                      {{ ticketResource.value().personal_region?.email }} /
                    </p>
                    <p class="">
                      {{ ticketResource.value().personal_region?.mobile_phone }} / {{
                      ticketResource.value().personal_region?.office_phone || 'Sin n√∫mero de oficina' }}
                    </p>
                  </div>
                </div>
                <div class="">
                  <div class="flex items-center gap-2">
                    <p class="text-secondary font-semibold">√Årea:</p>
                    <p class="first-letter:capitalize">
                      @for (area of ticketResource.value().personal_region?.groups_escalatory; track $index) {
                      {{ area.group_escalatory }}
                      }
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <p class="text-secondary font-semibold">Estado - Regi√≥n:</p>
                    <span class="first-letter:capitalize">
                      @for (state of ticketResource.value().personal_region?.states; track $index) {
                      {{ state.state }}
                      }-
                    </span>
                    <div class="first-letter:capitalize">
                      @for (state of ticketResource.value().personal_region?.states; track $index) {
                      {{ state.region.region }}
                      }
                    </div>
                  </div>
                </div>
              </div>
              } @else {
              <h5 class="text-secondary font-semibold">Personal √°rea resolutoria:</h5>
              <p>Este ticket, en su creaci√≥n, no fue asociado a personal de √°rea resolutoria.</p>
              }

              @let ticket = ticketResource.value();
              @if (ticket?.images && ticket.images!.length > 0) {
              <div class="space-y-4 mt-6">
                <div class="divider my-1"></div>

                <div>
                  <p class="text-sm font-medium text-secondary mb-3">Evidencias visuales del ticket</p>
                  <p class="text-xs text-gray-500 mb-4">
                    {{ ticket.images!.length }} imagen(es) adjunta(s) - Haga clic para ampliar
                  </p>

                  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    @for (item of ticket.images; track $index) {
                    @let imageUrl = getImageUrl(item);
                    <div class="relative group">
                      <a [href]="imageUrl" target="_blank" rel="noopener noreferrer" class="block cursor-pointer">
                        <img [src]="imageUrl" [alt]="'Evidencia ' + ($index + 1)"
                          class="w-full h-24 object-cover rounded-lg border border-base-300 shadow-sm transition-all duration-300 group-hover:scale-105 group-hover:shadow-md"
                          loading="lazy" (error)="handleImageError($event)" />
                      </a>
                      <div
                        class="absolute top-1 right-1 bg-primary text-white text-xs rounded-full w-5 h-5 flex items-center justify-center opacity-70 group-hover:opacity-100">
                        {{ $index + 1 }}
                      </div>
                    </div>
                    }
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pesta√±a de Seguimiento -->
  <input type="radio" name="my_tabs_3" class="tab text-yellow-500 font-bold" aria-label="Documentaciones" />
  <div class="tab-content bg-base-100 border-base-300 p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-primary">Historial de Documentaci√≥n</h2>
      <div>
        <div>
          <h3 class="text-lg font-bold text-accent uppercase">
            Ticket #{{ ticketResource.value().nro_ticket }}
          </h3>
        </div>
      </div>
      <button class="btn btn-primary" (click)="openModal()" [disabled]="!canCreateNewProgress()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nueva Documentaci√≥n
      </button>
    </div>

    @if (progressTicketsResource.isLoading()) {
    <div class="flex justify-center items-center py-8">
      <span class="loading loading-ring loading-lg"></span>
      <span class="ml-2">Cargando historial de documentaciones...</span>
    </div>
    }

    @if (progressTicketsResource.error()) {
    <div class="alert alert-error my-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>Error al cargar el historial de documentaciones: {{ progressTicketsResource.error()?.message }}</span>
    </div>
    }

    @if (hasProgressTickets) {
    <div class="space-y-6">
      <p class="text-sm text-gray-500 mb-4">
        Mostrando {{ progressTicketsCount }} registro(s) de documentaciones
      </p>

      @for (progress of progressTickets; track progress.id; let i = $index) {
      <div class="bg-base-200 rounded-xl p-6 shadow-sm border-l-4 border-primary">
        <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-4">
          <div class="flex-1">
            <h3 class="text-md font-semibold text-primary mb-2">Descripci√≥n:</h3>
            <div class="flex items-center gap-4 mb-4">
              <span class="badge badge-primary badge-lg">#{{ progressTicketsCount - i }}</span>
              <div class="flex flex-col justify-between text-sm font-mono">
                <div class="text-primary">

                  <!-- @if (ticketResource.value().network_elements?.length) {
                  <div class="space-y-2 mb-4">
                    <span class="font-semibold text-primary text-sm">Elementos de Red de inicio del ticket:</span>
                    <div class="flex flex-wrap gap-2">
                      @for (element of ticketResource.value().network_elements; track element.id; let i = $index) {
                      <div class="px-3 py-2 rounded-lg">
                        <span class="font-mono uppercase text-sm">
                          <span class="font-bold">#{{ i + 1 }}:</span>
                          {{ element.acronym }}
                          @if (element.management_ip) {
                          ({{ element.management_ip }})
                          }
                        </span>
                      </div>
                      }
                    </div>
                  </div>
                  } -->

                  @if (progress.network_elements?.length) {
                  <div class="space-y-2 mt-3">
                    <span class="font-semibold text-warning text-sm">Elementos de Red:</span>
                    <div class="flex flex-wrap gap-2">
                      @for (element of progress.network_elements; track element.id; let i = $index) {
                      <div class="bg-warning text-warning-content px-2 py-1 rounded text-xs">
                        <span class="font-mono uppercase">
                          {{ element.acronym }}
                          @if (element.management_ip) {
                          ({{ element.management_ip }})
                          }
                        </span>
                      </div>
                      }
                    </div>
                  </div>
                  }

                  @else if (progress.fiberLengthId) {
                  @let fiberInfo = getFiberDisplayInfo(progress);
                  <div class="space-y-2">
                    <span class="font-semibold text-primary text-sm">Tramo de Fibra:</span>
                    <div class="py-2 rounded-lg">
                      <span class="font-mono uppercase text-sm">
                        {{ fiberInfo.section_name }}
                        - Del Estado: {{ fiberInfo.stateA }}
                        - Al Estado: {{ fiberInfo.stateB }}
                      </span>
                    </div>
                  </div>
                  }

                </div>
                <div>
                  {{ progress.progress }}
                </div>
              </div>
            </div>

            <div class="space-y-1 text-md">
              <p>
                <span class="font-semibold text-primary mb-2">Propietario TT:</span>
                {{ ticketResource.value().user?.fullName }} {{ ticketResource.value().user?.surnames || '' }}
              </p>

              @if (progress.assignedUser) {
              <div class="flex justify-start gap-1">
                <div>
                  <span class="font-semibold text-primary mb-2">Asignado a:</span>
                </div>
                <div>
                  <p class="capitalize-names">
                    {{ progress.assignedUser.fullName }} {{ progress.assignedUser.surnames }}
                  </p>
                </div>
              </div>
              }

              @if (progress.personal_region) {
              <p>
                <span class="font-semibold text-primary mb-2 first-letter:uppercase">Personal de √°rea resolutoria:
                </span>
                <span class="capitalize">{{ progress.personal_region.names }} {{ progress.personal_region.surnames }}
                </span>
                <span class="capitalize">({{ progress.personal_region.states[0].state }})</span>
              </p>
              }
            </div>

          </div>

          <div class="text-right">
            <p class="text-sm text-gray-500">Creaci√≥n avance</p>
            <p class="font-medium">{{ progress.createdDate | date : "d/MM/yyyy" }}</p>
            <p class="text-sm">{{ formatVenezuelaTime(progress.createdDate.toString(), 'h:mm a') }}</p>

            <p class="text-sm text-gray-500">Por:</p>
            <p class="font-medium">{{ progress.user?.fullName }}</p>

            @if (progress.impact) {
            <div class="flex mt-8 gap-2">
              <p class="font-semibold text-warning uppercase">Impacto:</p>
              <p>{{ progress.impact }}</p>
            </div>
            }
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-base-300 rounded-lg">
          <div>
            <p class="text-sm font-medium text-gray-600">Hora Inicio Falla</p>
            <p class="font-mono text-sm">
              {{ ticketResource.value().date_hif | date : "d/MM/yyyy, h:mm a" }}
            </p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-600">Hora Diagn√≥stico</p>
            <p class="font-mono text-sm">
              {{ ticketResource.value().date_hdc | date : "d/MM/yyyy, h:mm a" }}
            </p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-600">Hora Contacto T√©cnico</p>
            <p class="font-mono text-sm">
              {{ ticketResource.value().date_hct | date : "d/MM/yyyy, h:mm a" }}
            </p>
          </div>
        </div>

        @if (progress.observations && progress.observations.trim() !== '') {
        <div class="mb-4 p-4 bg-base-300 rounded-lg">
          <p class="font-semibold text-primary mb-2">Avances:</p>
          <p class="whitespace-pre-line">{{ progress.observations }}</p>
        </div>
        }

        @if (progress.images && progress.images.length > 0) {
        <div class="mt-6">
          <p class="text-sm font-semibold text-gray-600 mb-3">
            Evidencias visuales ({{ progress.images.length }})
          </p>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            @for (image of progress.images; track $index) {
            <div class="relative group cursor-pointer" (click)="openImage(image)">
              <img [src]="image" alt="Evidencia de seguimiento"
                class="rounded-lg object-cover h-48 w-full transition-transform duration-300 group-hover:scale-105"
                (error)="handleImageError($event)">
              <div
                class="absolute inset-0 bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-300 rounded-lg flex items-center justify-center">
                <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3-3H7"></path>
                </svg>
              </div>
              <div
                class="absolute top-2 right-2 bg-primary text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
                {{ $index + 1 }}
              </div>
            </div>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
    } @else if (progressTicketsResource.hasValue()) {
    <div class="flex flex-col items-center justify-center py-12 text-center bg-base-200 rounded-xl">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <h3 class="text-lg font-semibold text-gray-600 mb-2">No hay seguimiento registrado</h3>
      <p class="text-gray-500 max-w-md">A√∫n no se han agregado registros de seguimiento para este ticket. El equipo
        t√©cnico actualizar√° esta secci√≥n conforme avance el proceso.</p>
    </div>
    }
  </div>

  <!-- Pesta√±a de Cierre -->
  <input type="radio" name="my_tabs_3" class="tab text-red-500 font-bold" aria-label="Cierre" />
  <div class="tab-content bg-base-100 border-base-300 p-6">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
      <div class="flex items-center gap-4">
        <h2 class="text-xl font-bold text-primary">Cierre del Ticket</h2>
        <h3 class="text-lg font-bold text-accent uppercase">
          #{{ ticketResource.value().nro_ticket }}
        </h3>
      </div>

      @if (ticketResource.value().closure) {
      <div class="flex items-center gap-6">
        <div class="text-center">
          <p class="text-sm font-medium">Estado:</p>
          <span class="text-lg font-bold uppercase">
            @if (ticketResource.value().statusId === 1) {
            <span class="badge bg-warning/20 text-warning badge-sm">EN PROCESO</span>
            }
            @else if (ticketResource.value().statusId === 2) {
            <span class="badge bg-error/20 text-error badge-sm">CANCELADO</span>
            }
            @else if (ticketResource.value().statusId === 3) {
            <span class="badge bg-success/20 text-success badge-sm">RESUELTO</span>
            }
          </span>
        </div>

        <div class="text-center">
          <p class="text-sm font-medium">Documentaciones:</p>
          <span class="text-xl font-bold text-primary">{{ progressTicketsCount }}</span>
        </div>
      </div>
      }
    </div>

    @if (ticketResource.value().closure) {
    @let closure = ticketResource.value().closure!;

    <div class="bg-base-200 p-4 rounded-xl mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-base-100 p-3 rounded-lg">
          <p class="text-xs font-medium text-gray-600">Fecha y hora de cierre:</p>
          <p class="font-semibold text-sm" *ngIf="closure.createdDate">
            {{ formatVenezuelaTime(closure.createdDate.toString(), 'dd/MM/yyyy, h:mm a') }}
          </p>
          <p class="font-semibold text-sm text-gray-500" *ngIf="!closure.createdDate">
            No disponible
          </p>
        </div>
        <div class="bg-base-100 p-3 rounded-lg">
          <p class="text-xs font-medium text-gray-600">Cerrado por:</p>
          <p class="font-semibold text-sm">{{ closure.user.fullName }}</p>
        </div>
        <div class="bg-base-100 p-3 rounded-lg">
          <p class="text-xs font-medium text-gray-600">Tiempo de resoluci√≥n:</p>
          <p class="font-semibold text-sm" *ngIf="closure.date_hlls && closure.date_hff">
            {{ calcularTiempoResolucion(closure.date_hlls, closure.date_hff) }}
          </p>
          <p class="font-semibold text-sm text-gray-500" *ngIf="!closure.date_hlls || !closure.date_hff">
            No disponible
          </p>
        </div>
      </div>

      <div class="bg-base-100 p-3 rounded-lg mb-4">
        <h4 class="font-semibold text-primary mb-2 text-sm">Categorizaci√≥n del Incidente</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
          <div class="bg-primary/5 p-2 rounded">
            <div class="font-bold text-primary text-xs uppercase">Grupo</div>
            <div class="capitalize text-xs truncate" [title]="closure.group">
              {{ closure.group || 'N/A' }}
            </div>
          </div>

          <div class="bg-warning/5 p-2 rounded">
            <div class="font-bold text-primary text-xs uppercase">Incidente</div>
            <div class="capitalize text-xs truncate" [title]="closure.incident">
              {{ closure.incident || 'N/A' }}
            </div>
          </div>

          <div class="bg-info/5 p-2 rounded">
            <div class="font-bold text-primary text-xs uppercase">Detalle</div>
            <div class="capitalize text-xs truncate" [title]="closure.incidentDetail">
              {{ closure.incidentDetail || 'N/A' }}
            </div>
          </div>

          <div class="bg-success/5 p-2 rounded">
            <div class="font-bold text-primary text-xs uppercase">Acciones</div>
            <div class="text-xs truncate" [title]="closure.action_taken">
              {{ (closure.action_taken || 'No especificadas').substring(0, 20) }}{{ (closure.action_taken || '').length
              > 20 ? '...' : '' }}
            </div>
          </div>
        </div>
      </div>

      <div class="bg-base-100 p-3 rounded-lg mb-4">
        <h4 class="font-semibold text-primary mb-2 text-sm">L√≠nea de Tiempo</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-center">
          <div class="bg-success/5 p-2 rounded">
            <div class="font-bold text-primary text-xs">Llegada al Sitio</div>
            <div class="font-mono text-xs" *ngIf="closure.date_hlls">
              {{ formatVenezuelaTime(closure.date_hlls.toString(), 'dd/MM/yyyy, h:mm a') }}
            </div>
            <div class="font-mono text-xs text-gray-500" *ngIf="!closure.date_hlls">
              <div>--/--/----</div>
              <div>--:-- --</div>
            </div>
          </div>

          <div class="bg-info/5 p-2 rounded">
            <div class="font-bold text-primary text-xs">Inicio Reparaci√≥n</div>
            <div class="font-mono text-xs" *ngIf="closure.date_hir">
              {{ formatVenezuelaTime(closure.date_hir.toString(), 'dd/MM/yyyy, h:mm a') }}
            </div>
            <div class="font-mono text-xs text-gray-500" *ngIf="!closure.date_hir">
              <div>--/--/----</div>
              <div>--:-- --</div>
            </div>
          </div>

          <div class="bg-warning/5 p-2 rounded">
            <div class="font-bold text-primary text-xs">Rest. Servicio</div>
            <div class="font-mono text-xs" *ngIf="closure.date_hrs">
              {{ formatVenezuelaTime(closure.date_hrs.toString(), 'dd/MM/yyyy, h:mm a') }}
            </div>
            <div class="font-mono text-xs text-gray-500" *ngIf="!closure.date_hrs">
              <div>--/--/----</div>
              <div>--:-- --</div>
            </div>
          </div>

          <div class="bg-error/5 p-2 rounded">
            <div class="font-bold text-primary text-xs">Fin de Falla</div>
            <div class="font-mono text-xs" *ngIf="closure.date_hff">
              {{ formatVenezuelaTime(closure.date_hff.toString(), 'dd/MM/yyyy, h:mm a') }}
            </div>
            <div class="font-mono text-xs text-gray-500" *ngIf="!closure.date_hff">
              <div>--/--/----</div>
              <div>--:-- --</div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-base-100 p-3 rounded-lg mb-4">
        <div class="collapse collapse-arrow border border-base-300">
          <input type="checkbox" class="peer" />
          <div class="flex gap-2 collapse-title font-semibold text-primary text-sm p-3">
            <p>Elementos de Red Involucrados</p>
            <p class="text-warning">(Click para expandir)</p>
          </div>
<div class="collapse-content">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
    <!-- Elemento Origen -->
    <div class="bg-base-200 p-3 rounded-lg">
      <h5 class="font-semibold text-primary mb-2 text-xs">
        Elemento(s) Origen
        @if (closure.network_element.length) {
          <span class="badge badge-primary badge-xs ml-1">{{ closure.network_element.length }}</span>
        }
      </h5>

      @if (closure.network_element.length) {
        <div class="space-y-3">
          @for (element of closure.network_element; track element.id; let i = $index) {
            <div class="bg-base-300 p-2 rounded">
              <div class="text-xs font-semibold text-primary mb-1">Elemento #{{ i + 1 }}</div>
              <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span class="font-medium">Acr√≥nimo:</span>
                  <span class="font-mono uppercase">{{ element.acronym || 'N/A' }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Descripci√≥n:</span>
                  <span class="capitalize truncate">{{ element.description || 'No especificada' }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Modelo:</span>
                  <span class="capitalize">{{ element.model || 'No especificado' }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Proveedor:</span>
                  <span class="capitalize">{{ element.provider.provider_name || 'No especificado' }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Central:</span>
                  <span class="capitalize">{{ element.central?.central_name || 'No especificada' }}</span>
                </div>
                @if (element.management_ip) {
                  <div class="flex justify-between">
                    <span class="font-medium">IP Gesti√≥n:</span>
                    <span class="font-mono">{{ element.management_ip }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="text-center text-gray-500 text-xs py-4">
          No hay elementos de origen registrados
        </div>
      }
    </div>

    <!-- Elemento de Cierre -->
<div class="bg-base-200 p-3 rounded-lg">
  <h5 class="font-semibold text-primary mb-2 text-xs">
    Elemento(s) de Cierre
    @if (closure.network_element_closure.length) {
      <span class="badge badge-primary badge-xs ml-1">{{ closure.network_element_closure.length }}</span>
    }
  </h5>

  @if (closure.network_element_closure.length) {
    <div class="space-y-3">
      @for (element of closure.network_element_closure; track element.id; let i = $index) {
        <div class="bg-base-300 p-2 rounded">
          <div class="text-xs font-semibold text-primary mb-1">Elemento #{{ i + 1 }}</div>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="font-medium">Acr√≥nimo:</span>
              <span class="font-mono uppercase">{{ element.acronym || 'N/A' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium">Descripci√≥n:</span>
              <span class="capitalize truncate">{{ element.description || 'No especificada' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium">Modelo:</span>
              <span class="capitalize">{{ element.model || 'No especificado' }}</span>
            </div>
            <!-- ‚úÖ ESTAS SON LAS L√çNEAS CR√çTICAS -->
            <div class="flex justify-between">
              <span class="font-medium">Proveedor:</span>
              <span class="capitalize">{{ element.provider.provider_name || 'No especificado' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium">Central:</span>
              <span class="capitalize">{{ element.central?.central_name || 'No especificada' }}</span>
            </div>
            <!-- FIN L√çNEAS CR√çTICAS -->
            @if (element.management_ip) {
              <div class="flex justify-between">
                <span class="font-medium">IP Gesti√≥n:</span>
                <span class="font-mono">{{ element.management_ip }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="text-center text-gray-500 text-xs py-4">
      No hay elementos de cierre registrados
    </div>
  }
</div>

  </div>
</div>
        </div>
      </div>

      <div class="bg-base-100 p-3 rounded-lg">
        <h4 class="font-semibold text-primary mb-2 text-sm">Impactos Reportados</h4>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
          <div class="bg-base-200 p-2 rounded text-center">
            <div class="font-bold text-primary text-xs">Inter BBIP</div>
            <div class="font-semibold text-lg" [class.text-warning]="closure.impacto_inter_bbip > 0"
              [class.text-gray-500]="closure.impacto_inter_bbip === 0">
              {{ closure.impacto_inter_bbip || 0 }}
            </div>
          </div>

          <div class="bg-base-200 p-2 rounded text-center">
            <div class="font-bold text-primary text-xs">Abon Voz</div>
            <div class="font-semibold text-lg" [class.text-warning]="closure.impacto_abon_voz > 0"
              [class.text-gray-500]="closure.impacto_abon_voz === 0">
              {{ closure.impacto_abon_voz || 0 }}
            </div>
          </div>

          <div class="bg-base-200 p-2 rounded text-center">
            <div class="font-bold text-primary text-xs">Ptos ABA</div>
            <div class="font-semibold text-lg" [class.text-warning]="closure.impacto_ptos_aba > 0"
              [class.text-gray-500]="closure.impacto_ptos_aba === 0">
              {{ closure.impacto_ptos_aba || 0 }}
            </div>
          </div>

          <div class="bg-base-200 p-2 rounded text-center">
            <div class="font-bold text-primary text-xs">Inter ME</div>
            <div class="font-semibold text-lg" [class.text-warning]="closure.impacto_inter_me > 0"
              [class.text-gray-500]="closure.impacto_inter_me === 0">
              {{ closure.impacto_inter_me || 0 }}
            </div>
          </div>

          <div class="bg-base-200 p-2 rounded text-center">
            <div class="font-bold text-primary text-xs">Circuitos</div>
            <div class="font-semibold text-lg" [class.text-warning]="closure.impacto_circuitos > 0"
              [class.text-gray-500]="closure.impacto_circuitos === 0">
              {{ closure.impacto_circuitos || 0 }}
            </div>
          </div>

          <div class="bg-base-200 p-2 rounded text-center">
            <div class="font-bold text-primary text-xs">Intercon</div>
            <div class="font-semibold text-lg" [class.text-warning]="closure.impacto_intercon > 0"
              [class.text-gray-500]="closure.impacto_intercon === 0">
              {{ closure.impacto_intercon || 0 }}
            </div>
          </div>
        </div>
      </div>

      @if (closure.action_taken) {
      <div class="mt-4">
        <div class="collapse collapse-arrow border border-base-300">
          <input type="checkbox" class="peer" />
          <div class="flex gap-2 collapse-title font-semibold text-primary text-sm p-3">
            <p>Acciones Tomadas</p>
            <p class="text-warning">(Click para expandir)</p>
          </div>
          <div class="collapse-content">
            <p class="bg-base-200 p-3 rounded text-sm">{{ closure.action_taken }}</p>
          </div>
        </div>
      </div>
      }
    </div>
    }

    @if (ticketResource.value().statusId === 2 && !ticketResource.value().closure) {
    @let ticket = ticketResource.value();
    <div class="bg-base-200 p-6 rounded-xl mb-6">
      <h3 class="text-lg font-bold text-error mb-4">‚ùå Ticket Cancelado</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <p class="text-sm font-medium text-gray-600">Fecha de cancelaci√≥n:</p>
          <p class="font-semibold">
            @if (ticket.cancelledAt) {
            {{ formatVenezuelaTime(ticket.cancelledAt, 'dd/MM/yyyy h:mm a') }}
            } @else {
            {{ formatVenezuelaTime(ticket.updatedDate, 'dd/MM/yyyy h:mm a') }}
            }
          </p>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-600">Cancelado por:</p>
          @if (ticket.cancelledBy) {
          <p class="font-semibold capitalize-names">{{ ticket.cancelledBy.fullName }}, {{ ticket.cancelledBy.surnames }}
          </p>
          } @else if (ticket.updatedBy) {
          <p class="font-semibold capitalize-names">{{ ticket.updatedBy.fullName }}</p>
          } @else {
          <p class="font-semibold capitalize-names">{{ ticket.user?.fullName || 'Sistema' }}</p>
          }
        </div>
      </div>

      @if (ticket.cancellation_note) {
      <div class="mt-4 bg-base-100 p-4 rounded-lg">
        <p class="text-sm font-semibold text-primary mb-2">Motivo de cancelaci√≥n:</p>
        <p class="mt-1 whitespace-pre-line">{{ ticket.cancellation_note }}</p>
      </div>
      } @else {
      <div class="mt-4 bg-base-100 p-4 rounded-lg">
        <p class="text-sm font-semibold">Raz√≥n de cancelaci√≥n:</p>
        <p class="mt-1 text-gray-500">No se especific√≥ un motivo de cancelaci√≥n.</p>
      </div>
      }
    </div>
    }

    @if (!ticketResource.value().closure && ticketResource.value().statusId !== 2) {
    <div class="bg-base-200 p-6 rounded-xl">
      @if (progressTicketsCount === 0) {
      <div class="alert alert-warning mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
          <h3 class="font-bold">Advertencia importante</h3>
          <div class="text-xs">No se han registrado documentaciones para este ticket.
            Se recomienda crear al menos una documentaci√≥n antes de proceder con el cierre.
            De lo contrario, considere cancelar el ticket.</div>
        </div>
      </div>
      }

      <form [formGroup]="closureForm" (ngSubmit)="onSubmitClosure()" class="space-y-4">
        <div class="bg-base-100 p-4 rounded-lg">
          <h4 class="font-semibold text-primary mb-3">üìã Datos del Cierre</h4>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Grupo *</span>
              </label>
              <select class="select select-bordered select-primary w-full" formControlName="groupId">
                <option [ngValue]="null" disabled selected>Seleccione un grupo</option>
                @for (group of groupsResource.value(); track group.id) {
                <option [ngValue]="group.id">{{ group.group }}</option>
                }
              </select>
              @if (closureForm.get('groupId')?.invalid && closureForm.get('groupId')?.touched) {
              <label class="label">
                <span class="label-text-alt text-error">Seleccione un grupo</span>
              </label>
              }
            </div>

            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Incidente *</span>
              </label>
              <select class="select select-bordered select-primary w-full" formControlName="incidentId"
                (change)="onIncidentChange($event)">
                <option [ngValue]="null" disabled selected>Seleccione un incidente</option>
                @for (incident of incidentsResource.value(); track incident.id) {
                <option [ngValue]="incident.id">{{ incident.incident_name }}</option>
                }
              </select>
              @if (closureForm.get('incidentId')?.invalid && closureForm.get('incidentId')?.touched) {
              <label class="label">
                <span class="label-text-alt text-error">Seleccione un incidente</span>
              </label>
              }
            </div>

            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Detalle del Incidente *</span>
              </label>
              <select class="select select-bordered select-primary w-full" formControlName="incidentDetailId"
                [class.opacity-50]="!closureForm.get('incidentDetailId')?.enabled"
                [class.cursor-not-allowed]="!closureForm.get('incidentDetailId')?.enabled">
                <option [ngValue]="null" disabled selected>
                  {{ closureForm.get('incidentId')?.value ? 'Seleccione un detalle' : 'Primero seleccione un incidente'
                  }}
                </option>
                @for (detail of filteredIncidentDetails(); track detail.id) {
                <option [ngValue]="detail.id">{{ detail.inc_detail_name }}</option>
                }
              </select>
              @if (closureForm.get('incidentDetailId')?.invalid && closureForm.get('incidentDetailId')?.touched) {
              <label class="label">
                <span class="label-text-alt text-error">Seleccione un detalle del incidente</span>
              </label>
              }
            </div>
          </div>

          <div class="form-control">

            @if (selectedClosureElementType() === 'network') {
            <div class="mb-4 p-4 bg-base-200 rounded-lg border-l-4 border-warning">
              <label class="label py-1">
                <span class="label-text font-medium text-warning">Elemento de red afectado (√öltima documentaci√≥n)</span>
              </label>

              @if (selectedClosureNetworkElements().length > 0) {
              <div class="space-y-2">
                @for (element of selectedClosureNetworkElements(); track element.id; let i = $index) {
                <div class="bg-warning/20 text-warning-content p-3 rounded-lg">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <div><strong>#{{ i + 1 }} - Acr√≥nimo:</strong> {{ element.acronym }}</div>
                    <div><strong>IP Gesti√≥n:</strong> {{ element.management_ip || 'N/A' }}</div>
                    <div><strong>Modelo:</strong> {{ element.model }}</div>
                    <div><strong>Central:</strong> {{ element.central?.central_name }}</div>
                    <div class="md:col-span-2"><strong>Descripci√≥n:</strong> {{ element.description }}</div>
                  </div>
                </div>
                }
              </div>
              } @else {
              <input type="text" class="input input-bordered input-warning w-full"
                value="No hay elementos de red en la √∫ltima documentaci√≥n" disabled>
              }

              <div class="text-xs text-warning mt-1">
                {{ selectedClosureNetworkElements().length }} elemento(s) de la √∫ltima documentaci√≥n (solo
                visualizaci√≥n)
              </div>
            </div>
            }

            <label class="label py-1">
              <span class="label-text font-medium">Elemento de Cierre *</span>
              <span class="label-text-alt text-warning">
                (@if (selectedClosureElementType() === 'network') {
                {{ selectedClosureNetworkElementsClosure().length }} Elemento(s) de Red
                }
                @else if (selectedClosureElementType() === 'fiber') { Tramo de Fibra }
                @else { Sin selecci√≥n })
              </span>
            </label>

            <!-- Botones de selecci√≥n de tipo -->
            <div class="flex gap-2 mb-3">
              <button type="button" class="btn btn-sm flex-1"
                [class.btn-primary]="selectedClosureElementType() === 'network'"
                [class.btn-outline]="selectedClosureElementType() !== 'network'"
                [class.btn-disabled]="selectedClosureElementType() === 'fiber'" (click)="openNetworkElementModal()"
                [disabled]="selectedClosureElementType() === 'fiber'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Elemento(s) de Red
                @if (selectedClosureElementType() === 'fiber') {
                <span class="badge badge-xs badge-error ml-1">‚ùå</span>
                }
              </button>
              <button type="button" class="btn btn-sm flex-1"
                [class.btn-primary]="selectedClosureElementType() === 'fiber'"
                [class.btn-outline]="selectedClosureElementType() !== 'fiber'"
                [class.btn-disabled]="selectedClosureElementType() === 'network'" (click)="openFiberElementModal()"
                [disabled]="selectedClosureElementType() === 'network'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Tramo de Fibra
                @if (selectedClosureElementType() === 'network') {
                <span class="badge badge-xs badge-error ml-1">‚ùå</span>
                }
              </button>
            </div>

            <!-- Informaci√≥n del elemento seleccionado -->
            @if (selectedClosureElementType() === 'network' && selectedClosureNetworkElementsClosure().length > 0) {
            <div class="mt-2 space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-primary">
                  {{ selectedClosureNetworkElementsClosure().length }} elemento(s) seleccionado(s)
                </span>
                <button type="button" class="btn btn-ghost btn-xs" (click)="clearClosureNetworkElement()">
                  Limpiar Todos
                </button>
              </div>

              @for (element of selectedClosureNetworkElementsClosure(); track element.id; let i = $index) {
              <div class="p-3 bg-base-200 rounded-lg border-l-4 border-primary">
                <div class="flex justify-between items-start">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm flex-1">
                    <div><strong>#{{ i + 1 }} - Acr√≥nimo:</strong> {{ element.acronym }}</div>
                    <div><strong>IP Gesti√≥n:</strong> {{ element.management_ip || 'N/A' }}</div>
                    <div><strong>Modelo:</strong> {{ element.model }}</div>
                    <div><strong>Central:</strong> {{ element.central?.central_name }}</div>
                    <div class="md:col-span-2"><strong>Descripci√≥n:</strong> {{ element.description }}</div>
                  </div>
                  <button type="button" class="btn btn-ghost btn-xs btn-error ml-2"
                    (click)="removeClosureNetworkElement(element)">
                    ‚úï
                  </button>
                </div>
              </div>
              }
            </div>
            }

            @if (selectedClosureElementType() === 'fiber' && selectedClosureFiberElement()) {
            <div class="mt-2 p-3 bg-base-200 rounded-lg border-l-4 border-secondary">
              <div class="flex justify-between items-start">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm flex-1 capitalize">
                  <div><strong>Tramo:</strong> {{ selectedClosureFiberElement()!.section_name }}</div>
                  @if (selectedClosureFiberElement()!.stateA?.state) {
                  <div><strong>Estado A:</strong> {{ selectedClosureFiberElement()!.stateA.state }}</div>
                  } @else {
                  <div><strong>Estado A:</strong> N/A</div>
                  }
                  @if (selectedClosureFiberElement()!.stateB?.state) {
                  <div><strong>Estado B:</strong> {{ selectedClosureFiberElement()!.stateB.state }}</div>
                  } @else {
                  <div><strong>Estado B:</strong> N/A</div>
                  }
                  <div><strong>Longitud:</strong> {{ selectedClosureFiberElement()!.length_km || 'N/A' }} km</div>
                </div>
                <button type="button" class="btn btn-ghost btn-xs ml-2" (click)="clearClosureFiberElement()">
                  Cambiar
                </button>
              </div>
            </div>
            }

            <!-- Validaci√≥n -->
            @if ((closureForm.get('networkElementClosureIds')?.invalid || closureForm.get('fiberLengthId')?.invalid) &&
            (closureForm.get('networkElementClosureIds')?.touched || closureForm.get('fiberLengthId')?.touched)) {
            <label class="label">
              <span class="label-text-alt text-error">Seleccione al menos un elemento de red o un tramo de fibra</span>
            </label>
            }
          </div>

        </div>

        <div class="bg-base-100 p-4 rounded-lg">
          <h4 class="font-semibold text-primary mb-3">‚è∞ Horas del Cierre</h4>
          <p class="text-sm text-warning italic">Fecha/Hora de referencia para el cierre (HCT): {{
            ticketResource.value().date_hct | date : "d/MM/yyyy, hh:mm a" }}</p>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <!-- Hora llegada sitio (HLLS) -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Hora llegada sitio (HLLS) *</span>
              </label>
              <input type="datetime-local" class="input input-bordered input-primary" formControlName="date_hlls"
                [class.border-orange-500]="isDateHllsInvalid()"
                [class.border-red-500]="closureForm.get('date_hlls')?.errors && closureForm.get('date_hlls')?.touched">
              @if (isDateHllsInvalid()) {
              <label class="label">
                <span class="text-orange-500 text-xs">‚ö†Ô∏è No puede ser anterior al contacto t√©cnico</span>
              </label>
              }
              @if (closureForm.get('date_hlls')?.errors?.['required'] && closureForm.get('date_hlls')?.touched) {
              <label class="label">
                <span class="text-red-500 text-xs">Este campo es requerido</span>
              </label>
              }
            </div>

            <!-- Hora inicio reparaci√≥n (HIR) -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Hora inicio reparaci√≥n (HIR) *</span>
              </label>
              <input type="datetime-local" class="input input-bordered input-primary" formControlName="date_hir"
                [class.border-orange-500]="isDateHirInvalid()"
                [class.border-red-500]="closureForm.get('date_hir')?.errors && closureForm.get('date_hir')?.touched">
              @if (isDateHirInvalid()) {
              <label class="label">
                <span class="text-orange-500 text-xs">‚ö†Ô∏è No puede ser anterior a la llegada al sitio</span>
              </label>
              }
              @if (closureForm.get('date_hir')?.errors?.['required'] && closureForm.get('date_hir')?.touched) {
              <label class="label">
                <span class="text-red-500 text-xs">Este campo es requerido</span>
              </label>
              }
            </div>

            <!-- Hora restablec. servicio (HRS) -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Hora restablec. servicio (HRS) *</span>
              </label>
              <input type="datetime-local" class="input input-bordered input-primary" formControlName="date_hrs"
                [class.border-orange-500]="isDateHrsInvalid()"
                [class.border-red-500]="closureForm.get('date_hrs')?.errors && closureForm.get('date_hrs')?.touched">
              @if (isDateHrsInvalid()) {
              <label class="label">
                <span class="text-orange-500 text-xs">‚ö†Ô∏è No puede ser anterior al inicio de reparaci√≥n</span>
              </label>
              }
              @if (closureForm.get('date_hrs')?.errors?.['required'] && closureForm.get('date_hrs')?.touched) {
              <label class="label">
                <span class="text-red-500 text-xs">Este campo es requerido</span>
              </label>
              }
            </div>

            <!-- Hora fin falla (HFF) -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium">Hora fin falla (HFF) *</span>
              </label>
              <input type="datetime-local" class="input input-bordered input-primary" formControlName="date_hff"
                [class.border-orange-500]="isDateHffInvalid()"
                [class.border-red-500]="closureForm.get('date_hff')?.errors && closureForm.get('date_hff')?.touched">
              @if (isDateHffInvalid()) {
              <label class="label">
                <span class="text-orange-500 text-xs">‚ö†Ô∏è No puede ser anterior al restablecimiento</span>
              </label>
              }
              @if (closureForm.get('date_hff')?.errors?.['required'] && closureForm.get('date_hff')?.touched) {
              <label class="label">
                <span class="text-red-500 text-xs">Este campo es requerido</span>
              </label>
              }
            </div>
          </div>
        </div>

        <div class="bg-base-100 p-4 rounded-lg">
          <h4 class="font-semibold text-primary mb-3">üìä Impactos del Incidente</h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-2">
                <input type="number" min="0" class="input input-bordered input-sm w-20"
                  formControlName="impacto_inter_bbip" placeholder="0">
                <span class="label-text">Inter BBIP</span>
              </label>
            </div>
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-2">
                <input type="number" min="0" class="input input-bordered input-sm w-20"
                  formControlName="impacto_abon_voz" placeholder="0">
                <span class="label-text">Abon Voz</span>
              </label>
            </div>
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-2">
                <input type="number" min="0" class="input input-bordered input-sm w-20"
                  formControlName="impacto_ptos_aba" placeholder="0">
                <span class="label-text">Ptos ABA</span>
              </label>
            </div>
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-2">
                <input type="number" min="0" class="input input-bordered input-sm w-20"
                  formControlName="impacto_inter_me" placeholder="0">
                <span class="label-text">Inter ME</span>
              </label>
            </div>
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-2">
                <input type="number" min="0" class="input input-bordered input-sm w-20"
                  formControlName="impacto_circuitos" placeholder="0">
                <span class="label-text">Circuitos</span>
              </label>
            </div>
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-2">
                <input type="number" min="0" class="input input-bordered input-sm w-20"
                  formControlName="impacto_intercon" placeholder="0">
                <span class="label-text">Intercon</span>
              </label>
            </div>
          </div>
        </div>

        <div class="bg-base-100 p-4 rounded-lg">
          <h4 class="font-semibold text-primary mb-3">üõ†Ô∏è Acciones Tomadas *</h4>
          <div class="form-control">
            <textarea placeholder="Describa en detalle las acciones realizadas para resolver el incidente..."
              class="textarea textarea-bordered textarea-primary h-32 w-full" formControlName="action_taken">
            </textarea>
            @if (closureForm.get('action_taken')?.invalid && closureForm.get('action_taken')?.touched) {
            <label class="label">
              <span class="label-text-alt text-error">
                @if (closureForm.get('action_taken')?.errors?.['required']) { Las acciones son requeridas }
                @if (closureForm.get('action_taken')?.errors?.['minlength']) { M√≠nimo 10 caracteres }
              </span>
            </label>
            }
          </div>
        </div>

        <div class="flex justify-end space-x-3 pt-2">
          @if (authService.isAdmin()) {
          <button type="button" class="btn btn-error" (click)="onCancelTicket()" [disabled]="isSubmittingClosure()">
            @if (isSubmittingClosure()) {
            <span class="loading loading-spinner loading-sm"></span>
            }
            Cancelar Ticket
          </button>
          }
          @else {
          <div class="tooltip tooltip-warning" data-tip="Debe solicitar a un supervisor la cancelaci√≥n del ticket">
            <button class="btn" disabled="disabled">Cancelar Ticket</button>
          </div>
          }

          <button type="submit" class="btn btn-success" [disabled]="isSubmittingClosure() || closureForm.invalid">
            @if (isSubmittingClosure()) {
            <span class="loading loading-spinner loading-sm"></span>
            Procesando...
            } @else {
            Cerrar Ticket
            }
          </button>
        </div>
      </form>
    </div>
    }
  </div>
</div>
}

<!-- Alert para validaciones de fecha/hora en cierre -->
@if (showDateTimeAlert()) {
<div class="fixed inset-0 flex items-end justify-center z-50 pointer-events-none">
  <div class="w-full max-w-md mb-8 mx-4">
    <div role="alert" class="alert alert-error alert-soft shadow-lg animate-fade-in-up">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div>
        <h3 class="font-bold">Error en fechas de cierre</h3>
        <div class="text-xs">{{ dateTimeAlertMessage() }}</div>
      </div>
    </div>
  </div>
</div>
}

<div class="flex justify-end">
  <button class="btn btn-secondary my-3" (click)="goBack()">
    <img class="" src="assets/icons/{{ 'material-symbols--keyboard-return' }}.svg">
    Regresar
  </button>
</div>

<!-- Modal para nuevo seguimiento -->
@if (showModal()) {
<div class="modal modal-open">
  <div class="modal-box max-w-5xl max-h-[95vh] overflow-y-auto">
    <h3 class="font-bold text-2xl text-primary mb-6 text-center">Seguimiento</h3>
    <form [formGroup]="progressForm" (ngSubmit)="onSubmit()" class="space-y-6">

      <div class="collapse collapse-arrow bg-base-200 border-base-300 border rounded-box">
        <input type="checkbox" class="peer" />
        <div class="collapse-title font-medium">
          <span class="flex items-center">
            Agregar nueva descripci√≥n al avance
          </span>
        </div>
        <div class="collapse-content">
          <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium mb-2">Descripci√≥n *</span>
              </label>
              <textarea placeholder="Describa en detalle la descripci√≥n de la nueva documentaci√≥n."
                class="textarea textarea-bordered textarea-primary w-full" formControlName="progress"
                [class.textarea-error]="progressForm.get('progress')?.invalid && progressForm.get('progress')?.touched">
              </textarea>
              @if (progressForm.get('progress')?.invalid && progressForm.get('progress')?.touched) {
              <label class="label">
                <span class="label-text-alt text-error">
                  @if (progressForm.get('progress')?.errors?.['required']) { La descripcion es requerida }
                  @if (progressForm.get('progress')?.errors?.['minlength']) { M√≠nimo 5 caracteres }
                </span>
              </label>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="bg-base-200 p-5 rounded-xl">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium mb-2">Avances *</span>
          </label>
          <textarea placeholder="Describa en detalle los avances realizados."
            class="textarea textarea-bordered textarea-primary w-full" formControlName="observations"
            [class.textarea-error]="progressForm.get('observations')?.invalid && progressForm.get('observations')?.touched">
          </textarea>
          @if (progressForm.get('observations')?.invalid && progressForm.get('observations')?.touched) {
          <label class="label">
            <span class="label-text-alt text-error">
              @if (progressForm.get('observations')?.errors?.['required']) { Los avances son requeridos }
              @if (progressForm.get('observations')?.errors?.['minlength']) { M√≠nimo 10 caracteres }
            </span>
          </label>
          }
        </div>
      </div>

      <div class="collapse collapse-arrow bg-base-200 border-base-300 border rounded-box">
        <input type="checkbox" class="peer" />
        <div class="collapse-title font-medium">
          <span class="flex items-center">
            Agregar nuevo Elemento de Red / Tramo de Fibra al avance
          </span>
        </div>
        <div class="collapse-content">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium mr-2">Tipo de Elemento</span>
              </label>
              <div class="join">
                <input type="radio" name="elementType" class="join-item btn" aria-label="Elementos de Red"
                  [checked]="selectedElementType() === 'network'" (change)="onElementTypeChange('network')">
                <input type="radio" name="elementType" class="join-item btn" aria-label="Tramos de Fibra"
                  [checked]="selectedElementType() === 'fiber'" (change)="onElementTypeChange('fiber')">
              </div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium mb-1">Elemento Seleccionado</span>
              </label>

              @if (selectedElementType() === 'network' && selectedNetworkElements().length > 0) {
              <div class="bg-base-200 p-3 rounded-lg">
                <p class="text-sm font-semibold mb-2">
                  {{ selectedNetworkElements().length }} elemento(s) de red seleccionado(s)
                </p>
                <div class="flex flex-wrap gap-2">
                  @for (element of selectedNetworkElements(); track element.id) {
                  <div class="bg-primary text-primary-content px-2 py-1 rounded text-xs flex items-center gap-1">
                    <span>{{ element.acronym }}</span>
                    <button type="button" class="btn btn-xs btn-ghost btn-circle"
                      (click)="removeNetworkElement(element)">
                      ‚úï
                    </button>
                  </div>
                  }
                </div>
              </div>
              }
              @else if (selectedElementType() === 'fiber' && selectedFiberElement()) {
              <div class="bg-base-200 p-3 rounded-lg border-l-4 border-secondary">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-sm font-semibold">Tramo de Fibra:</p>
                    <p class="font-mono uppercase text-sm">{{ selectedFiberElement().section_name }}</p>
                  </div>
                  <button type="button" class="btn btn-ghost btn-xs" (click)="clearFiberSelection()">
                    Cambiar
                  </button>
                </div>
              </div>
              }
              @else {
              <input type="text" class="input input-bordered input-primary" value="Ninguno"
                placeholder="Seleccione un elemento" readonly>
              }
            </div>

            <!-- <div class="form-control">
              <label class="label">
                <span class="label-text font-medium mb-1">Elemento Seleccionado</span>
              </label>
              <input type="text" class="input input-bordered input-primary"
                [value]="selectedElement()?.acronym || selectedElement()?.section_name || 'Ninguno'"
                placeholder="Seleccione un elemento" readonly>
            </div> -->
          </div>

          @if (selectedElementType() === 'network') {
          <div class="space-y-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text mr-2">Buscar elemento de red</span>
                <span class="label-text-alt text-primary">
                  {{ selectedNetworkElements().length }} elemento(s) seleccionado(s)
                </span>
              </label>
              <input type="text" placeholder="Buscar por acr√≥nimo o IP..." class="input input-bordered input-sm"
                [value]="searchNetworkQuery()" (input)="onNetworkSearchChange($event)">
              <div class="text-xs text-gray-500 mt-1">
                {{ networkSearchResults.length }} resultado(s) encontrado(s)
              </div>
            </div>

            <!-- Elementos seleccionados actualmente -->
            <!-- @if (selectedNetworkElements().length > 0) {
            <div class="bg-base-300 p-3 rounded-lg">
              <p class="font-semibold text-sm mb-2">Elementos seleccionados:</p>
              <div class="flex flex-wrap gap-2">
                @for (element of selectedNetworkElements(); track element.id; let i = $index) {
                <div class="bg-primary text-primary-content px-2 py-1 rounded text-xs flex items-center gap-1">
                  <span>{{ element.acronym }}</span>
                  <button type="button" class="btn btn-xs btn-ghost btn-circle" (click)="removeNetworkElement(element)">
                    ‚úï
                  </button>
                </div>
                }
              </div>
            </div>
            } -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium mb-1">Elemento Seleccionado</span>
              </label>

              @if (selectedElementType() === 'network' && selectedNetworkElements().length > 0) {
              <div class="bg-base-200 p-3 rounded-lg">
                <p class="text-sm font-semibold mb-2">
                  {{ selectedNetworkElements().length }} elemento(s) de red seleccionado(s)
                </p>
                <div class="flex flex-wrap gap-2">
                  @for (element of selectedNetworkElements(); track element.id) {
                  <div class="bg-primary text-primary-content px-2 py-1 rounded text-xs flex items-center gap-1">
                    <span>{{ element.acronym }}</span>
                    <button type="button" class="btn btn-xs btn-ghost btn-circle"
                      (click)="removeNetworkElement(element)">
                      ‚úï
                    </button>
                  </div>
                  }
                </div>
              </div>
              }
              @else if (selectedElementType() === 'fiber' && selectedFiberElement()) {
              <div class="bg-base-200 p-3 rounded-lg border-l-4 border-secondary">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-sm font-semibold">Tramo de Fibra:</p>
                    <p class="font-mono uppercase text-sm">{{ selectedFiberElement().section_name }}</p>
                  </div>
                  <button type="button" class="btn btn-ghost btn-xs" (click)="clearFiberSelection()">
                    Cambiar
                  </button>
                </div>
              </div>
              }
              @else {
              <input type="text" class="input input-bordered input-primary" value="Ninguno"
                placeholder="Seleccione un elemento" readonly>
              }
            </div>

            <div class="overflow-x-auto max-h-60 overflow-y-auto">
              <table class="table table-zebra table-sm">
                <thead class="sticky top-0 bg-base-200">
                  <tr>
                    <th>Seleccionar</th>
                    <th>Acr√≥nimo</th>
                    <th>IP Gesti√≥n</th>
                    <th>IP Servicio</th>
                    <th>Central</th>
                    <th>Descripci√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  @for (element of networkSearchResults; track element.id) {
                  <tr class="hover:bg-base-300 cursor-pointer" [class.bg-primary]="isNetworkElementSelected(element)">
                    <td>
                      @if (isNetworkElementSelected(element)) {
                      <button type="button" class="btn btn-xs btn-error" (click)="removeNetworkElement(element)">
                        Quitar
                      </button>
                      } @else {
                      <button type="button" class="btn btn-xs btn-primary" (click)="addNetworkElement(element)">
                        Agregar
                      </button>
                      }
                    </td>
                    <td class="font-mono uppercase">{{ element.acronym }}</td>
                    <td class="font-mono">{{ element.management_ip }}</td>
                    <td class="font-mono">{{ element.service_ip }}</td>
                    <td class="font-mono uppercase">{{ element.central?.central_name }}</td>
                    <td class="font-mono">{{ element.description }}</td>
                  </tr>
                  }
                  @if (networkSearchResults.length === 0 && searchNetworkQuery()) {
                  <tr>
                    <td colspan="6" class="text-center text-gray-500 py-4">
                      No se encontraron elementos de red
                    </td>
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          }

          @if (selectedElementType() === 'fiber') {
          <div class="space-y-3">
            <div class="form-control">
              <label class="label">
                <span class="label-text mr-2">Buscar tramo de fibra</span>
              </label>
              <input type="text" placeholder="Buscar por nombre de tramo o estado..."
                class="input input-bordered input-sm" [value]="searchFiberModalQuery()"
                (input)="onFiberModalSearchChange($event)">
              <div class="text-xs text-gray-500 mt-1">
                {{ modalFiberSearchResults.length }} resultado(s) encontrado(s)
              </div>
            </div>

            <div class="overflow-x-auto max-h-60 overflow-y-auto">
              <table class="table table-zebra table-sm">
                <thead class="sticky top-0 bg-base-200">
                  <tr>
                    <th>Seleccionar</th>
                    <th>Tramo</th>
                    <th>Del Estado</th>
                    <th>Al Estado</th>
                  </tr>
                </thead>
                <tbody>
                  @for (fiber of modalFiberSearchResults; track fiber.id) {
                  <tr class="hover:bg-base-300 cursor-pointer">
                    <td>
                      <button type="button" class="btn btn-xs btn-primary" (click)="selectFiberLength(fiber)">
                        Seleccionar
                      </button>
                    </td>
                    <td class="font-mono uppercase">{{ fiber.section_name }}</td>
                    <td class="uppercase">{{ fiber.stateA.state || 'N/A' }}</td>
                    <td class="uppercase">{{ fiber.stateB.state || 'N/A' }}</td>
                  </tr>
                  }
                  @if (modalFiberSearchResults.length === 0 && searchFiberQuery()) {
                  <tr>
                    <td colspan="4" class="text-center text-gray-500 py-4">
                      No se encontraron tramos de fibra para "{{ searchFiberQuery() }}"
                    </td>
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          }

        </div>
      </div>

      <div class="bg-base-200 p-5 rounded-xl">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Grupo *</span>
            </label>
            <select class="select select-bordered select-primary" formControlName="groupId">
              <option [ngValue]="null" disabled selected>Seleccione grupo</option>
              @for (group of groupsResource.value(); track group.id) {
              <option [ngValue]="group.id">
                {{ group.group }}
              </option>
              }
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Severidad *</span>
            </label>
            <select class="select select-bordered select-primary" formControlName="severityId">
              <option [ngValue]="null" disabled selected>Nivel de severidad</option>
              @for (severity of severitiesResource.value(); track severity.id) {
              <option [ngValue]="severity.id">
                {{ severity.severity }}
              </option>
              }
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Plataforma *</span>
            </label>
            <select class="select select-bordered select-primary" formControlName="platformId">
              <option [ngValue]="null" disabled selected>Seleccione plataforma</option>
              @for (platform of platformsResource.value(); track platform.id) {
              <option [ngValue]="platform.id">
                {{ platform.platform }}
              </option>
              }
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Origen *</span>
            </label>
            <select class="select select-bordered select-primary" formControlName="originId">
              <option [ngValue]="null" disabled selected>Origen del problema</option>
              @for (origin of originsResource.value(); track origin.id) {
              <option [ngValue]="origin.id">
                {{ origin.origin }}
              </option>
              }
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Tipo de Falla *</span>
            </label>
            <select class="select select-bordered select-primary" formControlName="failureId">
              <option [ngValue]="null" disabled selected>Tipo de falla</option>
              @for (failure of failuresResource.value(); track failure.id) {
              <option [ngValue]="failure.id">
                {{ failure.failure }}
              </option>
              }
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Impacto *</span>
            </label>
            <input type="text" placeholder="Impacto" class="input input-bordered input-primary"
              formControlName="impact">
          </div>
        </div>
      </div>

      <div class="bg-base-200 p-5 rounded-xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mr-2 mb-2">Regi√≥n Personal <span
                  class="text-gray-500 text-sm">(Opcional)</span></span>
            </label>
            <select class="select select-bordered select-primary" formControlName="personalRegionId">
              <option [ngValue]="null" selected>Sin regi√≥n espec√≠fica</option>
              @for (region of personalsRegionResource.value()?.personalsRegions; track region.id) {
              <option [ngValue]="region.id">
                {{ region.names }} {{ region.surnames }} - {{ region.states[0].state }}
              </option>
              }
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium mb-2">Usuario Asignado (Opcional)</span>
            </label>

            <!-- Select simplificado sin el input de b√∫squeda que no se usa -->
            <select class="select select-bordered select-primary" formControlName="assignedUserId">
              <option [ngValue]="null" selected>Sin usuario asignado</option>
              @for (user of allUsers(); track user.id) {
              <option [ngValue]="user.id">
                {{ user.fullName }} - {{ user.email }}
              </option>
              }
            </select>

            <div class="text-xs text-gray-500 mt-1">
              Deje en "Sin usuario asignado" si no requiere asignar un usuario espec√≠fico
            </div>
          </div>
        </div>
      </div>

      <div class="collapse collapse-arrow bg-base-200 border-base-300 border rounded-box">
        <input type="checkbox" class="peer" />
        <div class="collapse-title font-medium">
          <span class="flex items-center">
            üì∏ Agregar im√°genes de evidencias
            @if (selectedFiles().length > 0) {
            <span class="badge badge-primary badge-sm ml-2">{{ selectedFiles().length }}</span>
            }
          </span>
        </div>
        <div class="collapse-content">
          <div class="bg-base-200 p-5 rounded-xl">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium mb-2">Im√°genes de evidencia (Opcional)</span>
              </label>

              <input type="file" class="file-input file-input-bordered file-input-primary w-full"
                (change)="onFileSelected($event)" multiple accept="image/*" max="5">

              <div class="mt-3 text-sm text-gray-500">
                Formatos: JPG, PNG, GIF. Tama√±o m√°ximo: 5MB por archivo. M√°ximo 5 archivos.
              </div>

              @if (selectedFiles().length > 0) {
              <div class="mt-4 p-3 bg-base-100 rounded-lg border">
                <p class="text-sm font-medium text-gray-700 mb-2">Archivos seleccionados:</p>
                <div class="space-y-2">
                  @for (file of selectedFiles(); track file.name; let i = $index) {
                  <div class="flex items-center justify-between bg-base-200 p-2 rounded">
                    <div class="flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary mr-2" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span class="text-sm truncate max-w-xs">{{ file.name }}</span>
                      <span class="text-xs text-gray-500 ml-2">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                    </div>
                    <button type="button" class="btn btn-ghost btn-xs text-error" (click)="removeFile(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  }
                </div>
              </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button type="button" class="btn btn-ghost" (click)="closeModal()" [disabled]="isSubmitting()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting() || progressForm.invalid">
          @if (isSubmitting()) {
          <span class="loading loading-spinner loading-sm"></span>
          Creando Seguimiento...
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Crear Seguimiento
          }
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal para selecci√≥n de elementos de red en cierre -->
@if (showNetworkElementModal()) {
<div class="modal modal-open">
  <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
    <h3 class="font-bold text-2xl text-primary mb-6 text-center">Seleccionar Elemento de Red para Cierre</h3>

    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text font-medium">Buscar elemento de red</span>
      </label>
      <input type="text" placeholder="Buscar por acr√≥nimo, IP o descripci√≥n..."
        class="input input-bordered input-primary" [value]="closureNetworkSearchQuery()"
        (input)="onClosureNetworkSearchChange($event)">
    </div>

    <div class="overflow-x-auto max-h-96 overflow-y-auto">
      <table class="table table-zebra table-sm">
        <thead class="sticky top-0 bg-base-200">
          <tr>
            <th>Seleccionar</th>
            <th>Acr√≥nimo</th>
            <th>IP Gesti√≥n</th>
            <th>IP Servicio</th>
            <th>Modelo</th>
            <th>Central</th>
            <th>Descripci√≥n</th>
          </tr>
        </thead>
        <tbody>
          @for (element of closureNetworkSearchResults; track element.id) {
          <tr class="hover:bg-base-300 cursor-pointer" [class.bg-primary]="isClosureNetworkElementSelected(element)">
            <td>
              @if (isClosureNetworkElementSelected(element)) {
              <button type="button" class="btn btn-xs btn-error" (click)="removeClosureNetworkElement(element)">
                Quitar
              </button>
              } @else {
              <button type="button" class="btn btn-xs btn-primary" (click)="addClosureNetworkElement(element)">
                Agregar
              </button>
              }
            </td>
            <td class="font-mono uppercase">{{ element.acronym }}</td>
            <td class="font-mono">{{ element.management_ip || 'N/A' }}</td>
            <td class="font-mono">{{ element.service_ip || 'N/A' }}</td>
            <td class="uppercase">{{ element.model }}</td>
            <td class="uppercase">{{ element.central?.central_name }}</td>
            <td class="text-sm">{{ element.description }}</td>
          </tr>
          }
          @if (closureNetworkSearchResults.length === 0 && closureNetworkSearchQuery()) {
          <tr>
            <td colspan="7" class="text-center text-gray-500 py-4">
              No se encontraron elementos de red
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="modal-action">
      <button type="button" class="btn btn-ghost" (click)="closeNetworkElementModal()">Cancelar</button>
    </div>
  </div>
</div>
}


<!-- Modal para selecci√≥n de tramos de fibra en cierre -->
@if (showFiberElementModal()) {
<div class="modal modal-open">
  <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
    <h3 class="font-bold text-2xl text-primary mb-6 text-center">Seleccionar Tramo de Fibra para Cierre</h3>

    <!-- B√∫squeda -->
    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text font-medium">Buscar tramo de fibra</span>
      </label>
      <input type="text" placeholder="Buscar por nombre de tramo o estado..." class="input input-bordered input-primary"
        [value]="searchFiberClosureQuery()" (input)="onFiberClosureSearchChange($event)">
    </div>

    <!-- Tabla de resultados -->
    <div class="overflow-x-auto max-h-96 overflow-y-auto">
      <table class="table table-zebra table-sm">
        <thead class="sticky top-0 bg-base-200">
          <tr>
            <th>Seleccionar</th>
            <th>Tramo</th>
            <th>Estado A</th>
            <th>Estado B</th>
            <th>Longitud</th>
          </tr>
        </thead>
        <tbody>
          @for (fiber of closureFiberSearchResults; track fiber.id) {
          <tr class="hover:bg-base-300 cursor-pointer">
            <td>
              <button type="button" class="btn btn-xs btn-primary" (click)="selectClosureFiberElement(fiber)">
                Seleccionar
              </button>
            </td>
            <td class="font-mono uppercase">{{ fiber.section_name }}</td>
            <td class="uppercase">{{ fiber.stateA.state || 'N/A' }}</td>
            <td class="uppercase">{{ fiber.stateB.state || 'N/A' }}</td>
            <!-- <td class="font-mono">{{ fiber.length_km || 'N/A' }} km</td> -->
          </tr>
          }
          @if (closureFiberSearchResults.length === 0 && fiberSearchQuery()) {
          <tr>
            <td colspan="5" class="text-center text-gray-500 py-4">
              No se encontraron tramos de fibra para "{{ fiberSearchQuery() }}"
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="modal-action">
      <button type="button" class="btn btn-ghost" (click)="closeFiberElementModal()">Cancelar</button>
    </div>
  </div>
</div>
}

<!-- <div class="bg-warning text-warning-content p-2 rounded text-xs mt-2">
  Debug: Network Elements: {{ selectedNetworkElements().length }},
  Fiber: {{ selectedFiberElement() ? 'Yes' : 'No' }},
  Type: {{ selectedElementType() }}
</div> -->
